<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LokanStore-LSTV</title>
  
  <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script> 
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <style>
    :root {
      --main-bg: #0e0e0e;
      --secondary-bg: #1a1a1a;
      --accent-color: #cd1617;
      --text-color: #fff;
    }
    
    body {
      background-color: var(--main-bg);
      color: var(--text-color);
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .main-header {
      position: fixed;
      height: 25px;
      background: linear-gradient(to right, #cd1617, #a80f10);
      color: white;
      padding: 12px 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 6px 15px rgba(0,0,0,0.5);
      border-bottom: 2px solid rgba(255,255,255,0.1);
    }
    .header-title { flex-grow:1; text-align:center; font-size:1.4rem; font-weight:700; letter-spacing:1px; text-shadow:1px 1px 3px rgba(0,0,0,0.3);}
    .back-btn {
      background: rgba(255,255,255,0.15);
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display:flex;
      align-items:center;
      justify-content:center;
      transition: background 0.3s ease, transform 0.2s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      outline:none;
    }
    .back-btn:hover { background: rgba(255,255,255,0.3); transform: scale(1.05); }
    .back-btn:active { transform: scale(0.95); }
    .placeholder-div { width:40px; }
    h1 { display:none; }

    /* Player */
    .player-area {
      width: 100%;
      background-color: #000;
      aspect-ratio:16/9;
      max-height:400px;
      position: relative;
    }
    .player-header-info {
      position: absolute;
      top:0;
      right:0;
      left:0;
      z-index:10;
      padding:10px 20px;
      background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent);
      display:flex;
      justify-content:flex-start;
      align-items:center;
      pointer-events:none;
      color: var(--text-color);
      font-weight:700;
      text-align:right;
    }
    .channel-title { font-size:1.2rem; text-shadow:1px 1px 3px rgba(0,0,0,0.5); }

    /* Main layout with 40%-60% split */
    .main-layout {
      display: flex;
      flex: 1;
      max-width: 100%;
      margin:0 auto;
      padding:0;
      background-color: var(--main-bg);
      overflow:hidden;
    }
    #categories-bar {
      width: 400px;
      max-width: 300px;
      background-color: #282828;
      border-right: 1px solid #333;
      overflow-y: auto;
      height: calc(100vh - 250px);
      box-sizing: border-box;
      direction: ltr;
      text-align: left;
    }
    #channels-list-view {
      width: 600px;
      background-color: #1a1a1a;
      padding: 0;
      overflow-y: auto;
      height: calc(100vh - 250px);
      box-sizing: border-box;
    }

    .category-item {
      display:flex;
      align-items:center;
      padding:8px 12px;
      cursor:pointer;
      transition:background-color 0.2s,color 0.2s;
      font-size:0.85rem;
      text-align:left;
      flex-direction:row;
    }
    .category-icon { font-size:1rem; margin-left:6px; margin-right:6; }
    .category-item:hover { background-color:#383838; }
    .category-item.active { background-color:#1a1a1a; color:var(--text-color); border-left:8px solid var(--accent-color); }
    .category-item.active:hover { background-color:#1a1a1a; }

    #channelList {
      display:flex;
      flex-direction:column;
      gap:1px;
      padding:0;
    }
    .channel {
      display:flex;
      align-items:center;
      justify-content:flex-start;
      background:#1a1a1a;
      padding:10px 15px;
      cursor:pointer;
      border-bottom:1px solid #222;
      height:50px;
      box-sizing:border-box;
      text-align:left;
      transition: background-color 0.2s;
    }
    .channel:hover { 
      background:#3c3c3c;
    }
    .channel.active-ch { 
      background-color: #3c3c3c;
      color: yellow; 
    }

    .channel.active-ch span {
      color: yellow !important;
    }
    .channel img { 
      width:35px; 
      height:35px;
      object-fit:contain; 
      margin-left:2px; 
      margin-right:12px; 
      flex-shrink:0; 
      border-radius:0; 
    }
    .channel span { 
      font-size:1rem; 
      font-weight:400; 
      color:#fff; 
      white-space:nowrap; 
      overflow:hidden; 
      text-overflow:ellipsis; 
      flex-grow:1; 
      text-align:left; 
      line-height:1.2;
    }

    /* Style for the new Login Section */
    .login-section {
      position: fixed;
      top:50%;
      left:50%;
      transform: translate(-50%, -50%);
      display:block;
      background: #1b1b1b;
      padding:30px;
      border-radius:10px;
      max-width:350px;
      min-width:300px;
      z-index:1001;
      box-shadow:0 10px 25px rgba(0,0,0,0.7);
      text-align:center;
    }
    .login-section input[type="text"], .login-section input[type="url"], .login-section button { 
        margin:10px auto; 
        display:block; 
        width:calc(100% - 20px); 
        padding: 12px;
        border: 1px solid #333;
        border-radius: 5px;
        background: #252525;
        color: #fff;
        font-size: 1.1rem;
        text-align: center;
    }
    .login-section input[type="text"] {
        letter-spacing: 5px; /* Spacing for code input */
    }
    .login-section button {
        background: var(--accent-color);
        border: none;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.3s ease;
        letter-spacing: normal;
    }
    .login-section button:hover { background: #e02425; }
    .error-message { color: #ff5555; margin-top: 15px; font-size: 0.9rem; }
    
    /* Hide the old upload section */
    .upload-section { display: none !important; }

    #player-container .video-js { width:100%; height:100%; }
  </style>
</head>
<body>
  
  <div class="main-header" id="mainHeader">
      <button class="back-btn" id="backButton" onclick="handleBack()"><i class="fas fa-chevron-left"></i></button>
      <div class="header-title">LokanStore - LSTV</div>
      <div class="placeholder-div"></div>
  </div>

  <div class="player-area" id="playerArea">
      <div class="player-header-info">
          <span class="channel-title" id="current-channel-title">|LS| Select a Channel</span>
      </div>
      <video id="videojs-player" class="video-js vjs-default-skin vjs-big-play-centered" 
             playsinline controls autoplay preload="auto" crossorigin="anonymous">
      </video>
  </div>
  
  <div class="main-layout" id="mainLayout">
      <div id="categories-bar"></div>
      <div id="channels-list-view">
          <div id="channelList"></div>
      </div>
  </div>

  <div class="login-section" id="loginSection" style="display:none;">
      <h2>ğŸ”’LokanStore - LSTV</h2>
      <p style="color:#aaa; font-size:0.9rem;">Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚</p>
      <input type="text" id="codeInput" placeholder="&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;" maxlength="8" pattern="[0-9]*" inputmode="numeric">
      <button onclick="checkCode()" class="main-btn">Load & View Content</button>
      <div id="errorMessage" class="error-message"></div>
  </div>
  
  <div class="upload-section" id="uploadSection" style="display:none;">
      <h2>Load Channel List (M3U)</h2>
      <input type="url" id="urlInput" placeholder="ğŸ”— Enter M3U or M3U8 file URL">
      <input type="file" id="fileInput" accept=".m3u,.m3u8">
      <textarea id="m3uContent" rows="4" placeholder="Or paste M3U content here"></textarea><br>
      <button onclick="loadChannels()" class="main-btn">Load & View Content</button>
  </div>
  
  <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/videojs-contrib-hls@5.15.0/dist/videojs-contrib-hls.min.js"></script> 

  <script>
    let ALL_CHANNELS_BY_CATEGORY = { 'RÃ©cents': [], 'bein Sports': [], 'MBC': [], 'OSN': [], 'Algeria': [], 'Canal+ France': [], 'French': [], 'bein Enter...': [], 'Starz Play': [], 'Canal+ Africa': [], 'Other': [] };
    let ALL_CHANNELS = [];
    let globalPlayer = null;
    let currentCategory = null;
    let currentChannelElement = null;
    const CUSTOM_CATEGORIES_ORDER = ['RÃ©cents', 'bein Sports', 'MBC', 'OSN', 'Algeria', 'Canal+ France', 'French', 'bein Enter...', 'Starz Play', 'Canal+ Africa', 'Other'];

    function initializePlayer() {
        if (globalPlayer) return;
        const options = { controls:true, autoplay:false, preload:'auto', fluid:true, sources:[] };
        globalPlayer = videojs('videojs-player', options, function(){ console.log('Video.js player ready.'); });
        globalPlayer.on('error', function(){ document.getElementById('current-channel-title').textContent = '|LS| Error Loading Channel'; });
    }

    function playChannel(url, title, element) {
        initializePlayer();
        if (currentChannelElement) currentChannelElement.classList.remove('active-ch');
        element.classList.add('active-ch');
        currentChannelElement = element;
        document.getElementById('current-channel-title').textContent = title;
        globalPlayer.src({ src: url, type:'application/x-mpegURL' });
        globalPlayer.play().catch(e=>console.warn('Autoplay failed:',e));
    }

    function handleBack() { showLevelOne(); }
    function updateHeader(level) {
        const backBtn = document.getElementById('backButton');
        const headerTitle = document.querySelector('.header-title');
        headerTitle.textContent = 'LokanStore - LSTV';
        backBtn.style.visibility = (level===1)?'hidden':'visible';
    }

    function showLevelOne() {
        document.getElementById('loginSection').style.display='block';
        document.getElementById('mainLayout').style.display='none';
        document.getElementById('playerArea').style.display='none';
        document.getElementById('errorMessage').textContent = ''; 
        updateHeader(1);
    }

    function showLevelTwoAndThree() {
        document.getElementById('loginSection').style.display='none';
        document.getElementById('mainLayout').style.display='flex';
        document.getElementById('playerArea').style.display='block';
        updateCategoriesBar();
        if(CUSTOM_CATEGORIES_ORDER.length>0) showCategory(CUSTOM_CATEGORIES_ORDER[0]);
        updateHeader(2);
    }
    
    function showCategory(categoryName) {
        currentCategory = categoryName;
        document.querySelectorAll('.category-item').forEach(item => item.classList.remove('active'));
        document.querySelectorAll('.category-item').forEach(item => {
            if(item.getAttribute('data-category')===categoryName) item.classList.add('active');
        });
        const channelsToDisplay = ALL_CHANNELS_BY_CATEGORY[categoryName] || [];
        displayChannels(channelsToDisplay);
    }

    function updateCategoriesBar() {
        const bar = document.getElementById('categories-bar');
        bar.innerHTML = '';
        const categoryIcons = {
            'RÃ©cents':'fas fa-clock','bein Sports':'fas fa-futbol','MBC':'fas fa-tv',
            'OSN':'fas fa-film','Algeria':'fas fa-flag','Canal+ France':'fas fa-broadcast-tower',
            'French':'fas fa-globe-europe','bein Enter...':'fas fa-smile','Starz Play':'fas fa-star',
            'Canal+ Africa':'fas fa-globe-africa','Other':'fas fa-folder-open'
        };
        CUSTOM_CATEGORIES_ORDER.forEach(category => {
            const iconClass = categoryIcons[category] || 'fas fa-list';
            const div = document.createElement('div');
            div.className='category-item';
            div.setAttribute('data-category',category);
            div.onclick = ()=>showCategory(category);
            div.innerHTML=`<span class="category-icon"><i class="${iconClass}"></i></span><span style="flex-grow:1;text-align:left;margin-left:5px;">${category}</span>`;
            bar.appendChild(div);
        });
    }

    // Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø«Ø§Ø¨Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚
    async function loadChannelsFromInput(url) {
      if (!url) {
          document.getElementById('errorMessage').textContent = 'ğŸš« Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø±Ø§Ø¨Ø· M3U.';
          return;
      }
      try {
          const content = await fetchM3U(url);
          parseM3U(content);
          showLevelTwoAndThree();
      } catch (e) {
          document.getElementById('errorMessage').textContent = 'âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©: ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ùˆ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù….';
          console.error('Manual load failed:', e);
      }
    }

    // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„ (ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ø§Ø¨Ø· Ø«Ø§Ø¨Øª)
    function checkCode() {
        // **Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø«Ø§Ø¨Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„ØªØ­Ù…ÙŠÙ„**
        const CHANNEL_URL = 'https://lokans.github.io/Lokan/playlist.m3u'; 
        
        const codeInput = document.getElementById('codeInput');
        const code = codeInput.value.trim();
        const errorMsg = document.getElementById('errorMessage');
        errorMsg.textContent = '';

        if (code.length !== 8 || !/^\d+$/.test(code)) {
            errorMsg.textContent = 'Code Error .';
            return;
        }

        let sum = 0;
        for (let i = 0; i < code.length; i++) {
            sum += parseInt(code[i], 10);
        }

        if (sum === 20) {
            errorMsg.textContent = 'âœ… Ø±Ù…Ø² ØµØ­ÙŠØ­! ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ù†ÙˆØ§Øª...';
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ù…Ø² ØµØ­ÙŠØ­Ø§Ù‹ØŒ Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø«Ø§Ø¨Øª
            loadChannelsFromInput(CHANNEL_URL); 
        } else {
            errorMsg.textContent = `Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­`;
        }
    }

    // Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ M3U Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© Ù„ØªØ¬Ø§ÙˆØ² Ù…Ø´ÙƒÙ„Ø© CORS
    async function fetchM3U(url){
      // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø¯Ù…Ø© Ø¨Ø±ÙˆÙƒØ³ÙŠ Ù„ØªØ¬Ø§ÙˆØ² Ù‚ÙŠÙˆØ¯ CORS (corsproxy.io)
      const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(url);

      try{
        const res=await fetch(proxyUrl,{ headers:{'Cache-Control':'no-cache'}, mode:'cors' });
        
        if(!res.ok) throw new Error(`Failed to fetch M3U list via proxy. Status: ${res.status}`);
        return await res.text();
      } catch(error){ 
          console.error('Fetch M3U Error:', error); 
          throw new Error(`Network Error or CORS issue: ${error.message}`); 
      }
    }

    function parseM3U(content){
        const lines=content.split('\n');
        ALL_CHANNELS=[];
        ALL_CHANNELS_BY_CATEGORY=CUSTOM_CATEGORIES_ORDER.reduce((acc,cat)=>{ acc[cat]=[]; return acc; },{});
        let currentInfo=null;
        for(let line of lines){
            line=line.trim();
            if(line.startsWith('#EXTINF')){
                const nameMatch=line.match(/,(.*)$/);
                const logoMatch=line.match(/tvg-logo="(.*?)"/);
                const groupMatch=line.match(/group-title="(.*?)"/);
                let groupTitle=groupMatch?groupMatch[1].trim():'Other';
                let lowerGroup=groupTitle.toLowerCase();
                let assignedCategory='Other';
                if(lowerGroup.includes('mbc')) assignedCategory='MBC';
                else if(lowerGroup.includes('bein')||lowerGroup.includes('beinsports')) assignedCategory='bein Sports';
                else if(lowerGroup.includes('osn')) assignedCategory='OSN';
                else if(lowerGroup.includes('algeria')||lowerGroup.includes('dz')) assignedCategory='Algeria';
                else if(lowerGroup.includes('canal')&&lowerGroup.includes('france')) assignedCategory='Canal+ France';
                else if(lowerGroup.includes('french')||lowerGroup.includes('fr')) assignedCategory='French';
                else if(lowerGroup.includes('bein enter')) assignedCategory='bein Enter...';
                else if(lowerGroup.includes('starz')) assignedCategory='Starz Play';
                else if(lowerGroup.includes('canal')&&lowerGroup.includes('africa')) assignedCategory='Canal+ Africa';
                currentInfo={name:nameMatch?nameMatch[1].trim():'Unnamed Channel', logo:logoMatch?logoMatch[1]:null, group:assignedCategory};
            } else if(line && !line.startsWith('#')){
                if(currentInfo){
                    currentInfo.url=line.trim();
                    if(ALL_CHANNELS_BY_CATEGORY[currentInfo.group]) ALL_CHANNELS_BY_CATEGORY[currentInfo.group].push(currentInfo);
                    else { ALL_CHANNELS_BY_CATEGORY['Other'].push(currentInfo); currentInfo.group='Other'; }
                    ALL_CHANNELS.push(currentInfo); currentInfo=null;
                }
            }
        }
        ALL_CHANNELS_BY_CATEGORY['RÃ©cents']=ALL_CHANNELS.slice(0,5);
    }

    function displayChannels(channels){
      const list=document.getElementById('channelList');
      list.innerHTML='';
      const defaultLogo='https://lokans.github.io/Lokan/IMG_20250905_040549.jpg';
      if(channels.length===0){ list.innerHTML='<div style="color:#ccc;padding:20px;text-align:center;">No channels found in this category.</div>'; return; }
      channels.forEach(ch=>{
        const div=document.createElement('div');
        div.className='channel';
        div.innerHTML=`<img src="${ch.logo||defaultLogo}" alt="${ch.name} logo" loading="lazy" onerror="this.onerror=null;this.src='${defaultLogo}';"><span>${ch.name}</span>`;
        div.onclick=()=>playChannel(ch.url,ch.name,div);
        list.appendChild(div);
      });
    }

    function loadChannels() {
        // Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ÙƒØ§Ù†Øª ØªØ³ØªØ®Ø¯Ù… Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠØŒ ØªÙ… Ø¥ÙŠÙ‚Ø§ÙÙ‡Ø§ Ø§Ù„Ø¢Ù†
        // ÙˆØ§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ loadChannelsFromInput Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚
    }

    document.addEventListener('DOMContentLoaded', showLevelOne);
  </script>

</body>
</html>
